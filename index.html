<html>
	<head>
		<title>Ludum Dare 47 Title Pending</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.0/howler.min.js" integrity="sha512-ALoawPS0JxHQ+8dGL7htZIlVNRaE/SN9gHD4G8pJJTi9H4BQ/3PjdvhggSGR34g00mvTPFkxQuveQUsJA5664Q==" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/pinkfluffyunicorn/dist/pinkfluffyunicorn.min.js"></script>
		<script src="web/game.js"></script>
		<script src="web/sentences.js"></script>
	</head>
	<body>
		<div id="unicorn-display"></div>
		<h1 id="text"></h1>
		<button id="option_1" onclick="doAction(0)">Option 1</button>
		<button id="option_2" onclick="doAction(1)">Option 2</button>
		<button id="option_3" onclick="doAction(2)">Option 3</button>
		<script>
		const params = new URLSearchParams( location.search );
		window.WebFontConfig = {
			google: {
				families: [ 'Luckiest Guy', 'Geo', "Balsamiq Sans" ],
			},
			active() {
				CreateGame();
			},
		};

		/* eslint-disable */
		// include the web-font loader script
		(function() {
			const wf = document.createElement('script');
			wf.src = `${document.location.protocol === 'https:' ? 'https' : 'http'
			}://ajax.googleapis.com/ajax/libs/webfont/1/webfont.js`;
			wf.type = 'text/javascript';
			wf.async = 'true';
			const s = document.getElementsByTagName('script')[0];
			s.parentNode.insertBefore(wf, s);
		}());
		/* eslint-enabled */

		function CreateGame() {
			Unicorn.Create( "unicorn-display", {
				width: 1280,
				height: 720,
				background: params.get( "overlay" ) ? "transparent" : 0x777777,
				// background: "transparent",
				init: Init,
				update: Update,
				channel: params.get( "channel" ),
				onCommand: OnChatCommand,
				onChat: OnChatMessage,
				// screenWalls: false, // Default: true
				// wallBottom: true,
				gravity: { x: 0, y: 0 },
				// gravity: { x: 0, y: 2 } // Default: { x: 0, y: 1 }
			});
		}

		var t1 = new Date().getTime();
		let sfx_adopted = new Howl({
			src: [ `web/assets/adopted.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_denied = new Howl({
			src: [ `web/assets/denied.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_disappoint = new Howl({
			src: [ `web/assets/disappoint.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_neutral = new Howl({
			src: [ `web/assets/neutral.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_interested = new Howl({
			src: [ `web/assets/interested.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_veryinterested = new Howl({
			src: [ `web/assets/veryinterested.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let winMusic = new Howl({
			src: [ `web/assets/LD47_-_win.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.25,
			onend: function() {
				console.log( "end win music" );
			}
		});
		let music = new Howl({
		  src: [ 'web/assets/LD47-Mainthemev3.mp3' ],
		  autoplay: false,
		  loop: true,
		  volume: 0.10,
		  onplay: function() {
			  t1 = new Date().getTime();
		  },
		  onend: function() {
			  console.log('Finished!');
		  }
		});
		let beat = 60000/168;
		let beatBars = [2,14,26,36,48];
		let trackOffset = beat*2;
		music.play();
		function playWinMusic() {
			let diff = new Date().getTime() - t1;
			  let beats = Math.round((diff - trackOffset)/beat);
			  let waitTime = 0;
			  if (beats < 48) {
			  	let currentBeatBar = 2;
			  	for (i=3; i >= 0; i--) {
			    	if (beats > beatBars[i]) {
			        currentBeatBar = beatBars[i+1];
			        break;
			      }
			    }
			    // console.log(currentBeatBar);
			    waitTime = Math.round((currentBeatBar-beats)*beat);

			  } else if (beats < 388) {
			  	beats = Math.round((diff - 50*beat)/beat);
			    // console.log(beats);
			  	waitTime = Math.round((((beats - (beats % 8))/8 + 1)*8-beats) * beat);
			  } else {
			  	beats = Math.round((diff - 380*beat)/beat);
			    // console.log(beats);
			  	waitTime = Math.round((((beats - (beats % 8))/8 + 1)*8-beats) * beat);
			  }

			// console.log( "Waiting for " + waitTime + " miliseconds" );
			setTimeout( () => {
				// console.log( "NOW!" );
				// music.stop();
				sfx_adopted.play();
			}, waitTime );
		}

		let textCounter = 0;
		async function showText( text, delay = 0, time = 5000, font = "Balsamiq Sans", anim = "" ) {
			// document.getElementById( "text" ).innerText = text;
			await wait( delay );
			textCounter++;
			let label = "text_" + textCounter;
			let xPos = getRandomInt( 1280 - 80 ) + 40;
			let yPos = getRandomInt( 720 - 80 ) + 40;
			let element = Unicorn.AddText( label, text, xPos, yPos, {
				fontFamily: font,
				fontSize: 36,
				fontWeight: "bold",
				fill: "#000000"
			} );
			element.anchor.set( 0.5 );
			console.log( element );
			xPos = getRandomInt( 1280 - element.width - 80 ) + 40 + element.width / 2;
			yPos = getRandomInt( 720 - element.height - 80 ) + 40 + element.height / 2;
			element.x = xPos;
			element.y = yPos;
			setTimeout( () => {
				Unicorn.RemoveText( label );
			}, time );
		}

		let player = {
			"type": "dog",
			"stats": {
				"cute": 0,
				"energetic": 0,
				"fluffy": 0,
				"happy": 0,
				"confident": 0,
				"relaxed": 0,
				"playful": 0,
			}
		};
		let actionOptions = [];
		let previousScore = 0, totalScore = 0, round = 0;
		const numRounds = 5;
		let traits = null;
		let visitor_basestats;
		let visitor;

		function Init() {
			// TODO: randomize player stats

			setupNewDay();
		}

		function Update( timestamp, timeDiffInMs ) {
		}

		function OnChatCommand( user, command, message, flags ) {
		}

		function OnChatMessage( user, message, flags, self ) {
		}

		async function setupNewDay() {
			previousScore = 0; totalScore = 0; round = 0;
			showText( NewDay[ getRandomInt( NewDay.length ) ] );
			await wait( 5000 );
			traits = createVisitor();
			visitor_basestats = calculateVisitorStats( traits );
			// console.log( traits, visitor_basestats );
			// console.log( "STATS:", statsScore( visitor_basestats, player.stats ) );
			visitor = Object.assign( {}, visitor_basestats );
			// console.log( `${traits[ 0 ]}_${traits[ 1 ]}` );

			let intros = Introductions[ `${traits[ 0 ]}_${traits[ 1 ]}` ];
			showText( intros[ getRandomInt( intros.length ) ] );
			showText( getRandomVisitorDescription(), 5000 );
			showText( getRandomVisitorDescription(), 10000 );
			showText( getRandomVisitorDescription(), 15000 );
			setupRound();
		}

		//
		// for( let i = 0; i < 3; i++ ) {
		// 	let actions = getActions( player );
		// 	console.log( actions );
		// 	let actionNames = Object.keys( actions );
		// 	let action = actionNames[ getRandomInt( actionNames.length ) ];
		// 	console.log( action, actions[ action ].desc[ 0 ] );
		// 	player = applyAction( player, action );
		// 	// Object.keys( player.stats ).forEach( s => {
		// 	// 	console.log( s, player.stats[ s ] );
		// 	// });
		//
		// 	// console.log( player );
		// 	console.log( "STATS:", statsScore( visitor, player.stats ) );
		// }
		// console.log( visitor, player );

		function getRandomVisitorDescription() {
			let otherTraits = traits.slice( 1 );
			let randomTrait = otherTraits[ getRandomInt( otherTraits.length ) ];
			let descriptions = Descriptions[ traits[ 0 ] ][ randomTrait ];
			return descriptions[ getRandomInt( descriptions.length ) ];
		}

		async function doAction( index ) {
			let actions = getActions( player );
			let descriptions = actions[ actionOptions[ index ] ].desc;
			showText( descriptions[ getRandomInt( descriptions.length ) ] );
			player = applyAction( player, actionOptions[ index ] );
			let score = statsScore( visitor, player.stats );
			let prevTotal = totalScore;
			totalScore += score;
			const goalTotalScore = numRounds * 4;
			let reactions = Reactions[ traits[ 0 ] ];
			console.log( round, numRounds, previousScore, score, reactions );
			await wait( 3000 );
			if( round >= numRounds ) {
				// Final round!
				if( totalScore >= goalTotalScore ) {
					// Adopted! YAY!
					playWinMusic();
					showText( reactions.adopted[ getRandomInt( reactions.adopted.length ) ] );
					showText( Celebration[ getRandomInt( Celebration.length ) ], 5000 );
				}
				else {
					// Not adopted... next visitor!
					sfx_denied.play();
					showText( reactions.denied[ getRandomInt( reactions.denied.length ) ] );
					showText( Encouragement[ getRandomInt( Encouragement.length ) ], 5000 );
					await wait( 5000 );
					setupNewDay();
				}
			}
			else {
				if( score < previousScore ) {
					sfx_disappoint.play();
					showText( reactions.disappointed[ getRandomInt( reactions.disappointed.length ) ] );
				}
				else if( score === previousScore ) {
					sfx_neutral.play();
					showText( reactions.neutral[ getRandomInt( reactions.neutral.length ) ] );
				}
				else if( round < 3 || score < previousScore + 1 ) {
					sfx_interested.play();
					showText( reactions.interested[ getRandomInt( reactions.interested.length ) ] );
				}
				else {
					sfx_veryinterested.play();
					showText( reactions.veryinterested[ getRandomInt( reactions.veryinterested.length ) ] );
				}
				setupRound();
			}
			console.log( "STATS:", score );
			previousScore = score;
		}

		function setupRound() {
			round++;
			let actions = getActions( player );
			console.log( actions );
			let actionNames = Object.keys( actions );
			shuffleArray( actionNames );
			for( let i = 0; i < 3; i++ ) {
				document.getElementById( `option_${i+1}` ).innerText = actions[ actionNames[ i ] ].name;
			}
			actionOptions = actionNames.slice( 0, 3 );
		}
		</script>
	</body>
</html>
