<html>
	<head>
		<title>Ludum Dare 47 Title Pending</title>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.0/howler.min.js" integrity="sha512-ALoawPS0JxHQ+8dGL7htZIlVNRaE/SN9gHD4G8pJJTi9H4BQ/3PjdvhggSGR34g00mvTPFkxQuveQUsJA5664Q==" crossorigin="anonymous"></script>
		<script src="web/game.js"></script>
		<script src="web/sentences.js"></script>
	</head>
	<body>
		<h1 id="text"></h1>
		<button id="option_1" onclick="doAction(0)">Option 1</button>
		<button id="option_2" onclick="doAction(1)">Option 2</button>
		<button id="option_3" onclick="doAction(2)">Option 3</button>
		<script>
		var t1 = new Date().getTime();
		let sfx_adopted = new Howl({
			src: [ `web/assets/adopted.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_denied = new Howl({
			src: [ `web/assets/denied.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_disappoint = new Howl({
			src: [ `web/assets/disappoint.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_neutral = new Howl({
			src: [ `web/assets/neutral.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_interested = new Howl({
			src: [ `web/assets/interested.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let sfx_veryinterested = new Howl({
			src: [ `web/assets/veryinterested.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.5
		});
		let winMusic = new Howl({
			src: [ `web/assets/LD47_-_win.mp3` ],
			autoplay: false,
			loop: false,
			volume: 0.25,
			onend: function() {
				console.log( "end win music" );
			}
		});
		let music = new Howl({
		  src: [ 'web/assets/LD47-Mainthemev3.mp3' ],
		  autoplay: false,
		  loop: true,
		  volume: 0.15,
		  onplay: function() {
			  t1 = new Date().getTime();
		  },
		  onend: function() {
			  console.log('Finished!');
		  }
		});
		const beat = 60000 / 168;
		const trackOffset = beat*2;
		music.play();
		function playWinMusic() {
			let diff = new Date().getTime() - t1;
			let beats = (diff - trackOffset)/beat;
			let waitTime = Math.round((((beats - (beats % 8))/8 + 1)*8-beats) * beat);

			console.log( "Waiting for " + waitTime + " miliseconds" );
			setTimeout( () => {
				console.log( "NOW!" );
				// music.stop();
				sfx_adopted.play();
			}, waitTime );
		}
		function showText( text ) {
			document.getElementById( "text" ).innerText = text;
		}
		let player = {
			"type": "dog",
			"stats": {
				"cute": 0,
				"energetic": 0,
				"fluffy": 0,
				"happy": 0,
				"confident": 0,
				"relaxed": 0,
				"playful": 0,
			}
		};
		let actionOptions = [];
		let previousScore = 0, totalScore = 0, round = 0;
		const numRounds = 5;
		let traits = null;
		let visitor_basestats;
		let visitor;

		// TODO: randomize player stats

		setupNewDay();

		function setupNewDay() {
			previousScore = 0; totalScore = 0; round = 0;
			showText( NewDay[ getRandomInt( NewDay.length ) ] );
			setTimeout( () => {
				traits = createVisitor();
				visitor_basestats = calculateVisitorStats( traits );
				console.log( traits, visitor_basestats );
				console.log( "STATS:", statsScore( visitor_basestats, player.stats ) );
				visitor = Object.assign( {}, visitor_basestats );
				console.log( `${traits[ 0 ]}_${traits[ 1 ]}` );

				let intros = Introductions[ `${traits[ 0 ]}_${traits[ 1 ]}` ];
				showText( intros[ getRandomInt( intros.length ) ] );
				setTimeout( () => {
					let desc = getRandomVisitorDescription();
					showText( desc );
				}, 5000 );
				setTimeout( () => {
					let desc = getRandomVisitorDescription();
					showText( desc );
				}, 10000 );
				setTimeout( () => {
					let desc = getRandomVisitorDescription();
					showText( desc );
				}, 15000 );
				setupRound();
			}, 5000 );
		}

		//
		// for( let i = 0; i < 3; i++ ) {
		// 	let actions = getActions( player );
		// 	console.log( actions );
		// 	let actionNames = Object.keys( actions );
		// 	let action = actionNames[ getRandomInt( actionNames.length ) ];
		// 	console.log( action, actions[ action ].desc[ 0 ] );
		// 	player = applyAction( player, action );
		// 	// Object.keys( player.stats ).forEach( s => {
		// 	// 	console.log( s, player.stats[ s ] );
		// 	// });
		//
		// 	// console.log( player );
		// 	console.log( "STATS:", statsScore( visitor, player.stats ) );
		// }
		// console.log( visitor, player );

		function getRandomVisitorDescription() {
			let otherTraits = traits.slice( 1 );
			let randomTrait = otherTraits[ getRandomInt( otherTraits.length ) ];
			let descriptions = Descriptions[ traits[ 0 ] ][ randomTrait ];
			return descriptions[ getRandomInt( descriptions.length ) ];
		}

		function doAction( index ) {
			player = applyAction( player, actionOptions[ index ] );
			let score = statsScore( visitor, player.stats );
			let prevTotal = totalScore;
			totalScore += score;
			const goalTotalScore = numRounds * 4;
			let reactions = Reactions[ traits[ 0 ] ];
			console.log( round, numRounds, previousScore, score, reactions );
			if( round >= numRounds ) {
				// Final round!
				if( totalScore >= goalTotalScore ) {
					// Adopted! YAY!
					playWinMusic();
					showText( reactions.adopted[ getRandomInt( reactions.adopted.length ) ] );
					setTimeout( () => {
						showText( Celebration[ getRandomInt( Celebration.length ) ] );
					}, 5000 );
				}
				else {
					// Not adopted... next visitor!
					sfx_denied.play();
					showText( reactions.denied[ getRandomInt( reactions.denied.length ) ] );
					setTimeout( () => {
						showText( Encouragement[ getRandomInt( Encouragement.length ) ] );
						setTimeout( () => {
							setupNewDay();
						}, 3000 );
					}, 5000 );
				}
			}
			else {
				if( score < previousScore ) {
					sfx_disappoint.play();
					showText( reactions.disappointed[ getRandomInt( reactions.disappointed.length ) ] );
				}
				else if( score === previousScore ) {
					sfx_neutral.play();
					showText( reactions.neutral[ getRandomInt( reactions.neutral.length ) ] );
				}
				else if( round < 3 || score < previousScore + 1 ) {
					sfx_interested.play();
					showText( reactions.interested[ getRandomInt( reactions.interested.length ) ] );
				}
				else {
					sfx_veryinterested.play();
					showText( reactions.veryinterested[ getRandomInt( reactions.veryinterested.length ) ] );
				}
				setupRound();
			}
			console.log( "STATS:", score );
			previousScore = score;
		}

		function setupRound() {
			round++;
			let actions = getActions( player );
			console.log( actions );
			let actionNames = Object.keys( actions );
			shuffleArray( actionNames );
			for( let i = 0; i < 3; i++ ) {
				document.getElementById( `option_${i+1}` ).innerText = actions[ actionNames[ i ] ].name;
			}
			actionOptions = actionNames.slice( 0, 3 );
		}
		</script>
	</body>
</html>
